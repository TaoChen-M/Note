# 图解IP协议

IP协议位于TCP/IP四层结构的网络层，主要目的是实现“主机终端节点之间的通信”，主要分为三大作用模块：IP寻址、路由（最终节点为止的转发）、IP分包和组包

## IP地址的基础知识

IP地址由32位正整数来表示，将32位的IP以8位为一组，分成四组，每组以‘.’隔开，再将每组数转变为十进制

![](/images/IP地址.png)

实际应用过程中，IP地址由“网络标识（网络地址）”和“主机标识（主机地址）”两部分组成，比如19 2.168.128.10/24，其中24表示从第1位开始到第24位都是网络地址。

网络标识必须保证相互连接的每个段的地址不相重复，而相同段内连接的主机必须具有相同的网络地址，而主机标识则不允许重复出现，这样IP地址就具有了唯一性

![](/images/网络标识和主机标识.png)

## 全局地址和私有地址

通常来说互联网中的任何一台主机或者路由器的IP地址都是唯一的，但是鉴于IP地址的稀缺性，使用NAT协议来解决私有地址和全局地址之间的转换问题。私有地址即一个局域网内部的地址，在这个范围内的IP地址可以随意分配，只要保证在这个局域网内地址是唯一的即可。而这个局域网与外部通信时，在必要的路由器或者服务器上设置一个全局IP地址，配有私有IP地址的主机通过NAT协议与互联网通信。全局IP地址在整个互联网范围内保持唯一。不同的域里出现相同的IP地址并不互相影响。

## 路由控制

路由控制表中记录着网络地址和下一步应该发送的路由器的地址。发送IP包时，首先确定IP包首部中的目标地址，再从路由表中找到与该地址具有相同的网络地址的记录，根据记录将IP包转发给相应的下一个路由器。如果路由控制表中存在多条相同的网络地址的记录，选择一个相同位数最多的地址。

### 环回地址

环回地址是指同一台计算机上的程序之间进行网络通信使用的默认地址，时127.0.0.1，主机名时localhost

## DNS查询

解析器为了查明域名对应的IP地址，向域名服务器进行查询处理，接收到这个查询请求的域名服务器首先在自己的数据库进行查找，如果有该域名对应的IP地址就直接返回，如果没有向上一层根域名服务器进行查询处理。解析器和域名服务器将最新了解到的信息保存在缓存里，这样每次查询时可以降低性能消耗。

![](/images/DNS解析过程.png)

## ARP协议

ARP协议实现从IP地址到MAC地址的映射，以IP地址为线索，定位下一个接收数据包的主机MAC地址，如果目标主机不在同一个链路上，查找吓一跳路由器的MAC地址。

ARP是借助ARP请求和响应两种类型的包确定MAC地址。发送主机起初通过广播发送一个ARP请求包，包中包含了想要了解MAC地址的IP主机地址，因为广播会被同一个链路上的所有主机和路由器接收，如果目标IP地址和自己的IP地址一致，那么该节点就会将自己的MAC地址塞入ARP响应包返回给发送主机。

![](/images/ARP.png)

## ICMP协议

ICMP协议主要功能有确认IP包是否成功送达目标地址，通知在发送过程中IP包被丢弃的原因，改善网络设置等

### ICMP目标不可达消息

IP路由器不能将数据包发送给目标地址时，会给发送端主机返回一个目标不可达的ICMP消息，并且在这个消息中显示目标不可达的具体原因，通常错误代码都是1标识主机不可达，即路由表中没有这个主机的消息或者该主机没有连接到网络上

### ICMP重定向消息

如果路由器发现发送端主机使用了次优的路径发送数据，那么会返回一个ICMP重定向消息给主机，消息中包含了最合适的路由信息和源数据

### ICMP超时消息

IP包中有一个字段为TTL（Time To Live，生存周期），该值在每经过一次路由之后就会减一，直到0，该数据包被丢弃。此时路由器发送一个ICMP超时消息给发送端主机，通知该包已经被丢弃。

设置IP包生存周期主要目的是防止发生循环状况，避免数据包被无休止在网络上转发

### ICMP回送消息

用于进行通信的主机或者路由器之间，判断所发送的数据包是否已经成功到达对端的一种消息。可以向对端主机发送回送请求的消息，也可以接收对端主机发回来的回送应答消息。最常用的ping命令就是利用这个消息实现的。     

## DHCP协议

DHCP协议用来自动设置和分配IP地址，在使用DHCP之前将可用的IP地址和子网掩码和路由控制信息以及DNS服务器的地址设置到DHCP服务器上。DHCP分配IP地址有两种方法，一种是由DHCP服务器在特定的IP地址中自动选择一个进行分配，另外一种是针对MAC地址分配一个固定的IP地址。

![](/images/DHCP.png)

DHCP获得IP地址的四个步骤：

- 客户端发起DHCP报文的IP数据包，因为客户端没有IP地址并且不知道DHCP服务器的IP地址，因此使用的是UDP广播，广播地址是255.255.255.255，通过数据链路层广播到所有网络中的设备
- DHCP服务器收到DHCP发现报文之后，用DHCP提供报文做出响应，仍然使用255.255.255.255广播地址，报文信息携带可供使用的IP地址、子网掩码、DNS服务器和租用期
- 客户端收到一个或者多个DHCP提供报文之后从中选择一个，并发送DHCP请求报文进行响应
- 最后服务端用DHCP ACK报文对DHCP请求报文进行响应

### 在分配的过程中如何确定分配的IP地址没有冲突？

- DHCP服务器：在分配IP地址前发送ICMP回送请求包，确认没有返回应答
- DHCP客户端：针对从DHCP那里获得的IP地址发送ARP请求包，确认没有返回应答

### DHCP中继代理

家庭网络中只有一个以太网（无线LAN）网段，只有一个DHCP服务器即可应对IP地址的分配需求，并且DHCP服务器都由宽带路由器来充当这个角色。在学校或者企业中一般会有多个以太网段，如果针对每个以太网段都设置一个DHCP服务器是一个庞大的工程，这种状况在每一个网段使用一个中继代理（中继代理多数都是路由器）来实现，DHCP客户端向DHCP中继代理发送DHCP请求包（包中包含了请求主机的MAC地址，中继代理利用这个MAC地址将包返还给客户端），而中继代理收到这个广播包以后以单播的形式发送给DHCP服务器。

![](/images/DHCP中继代理.png)

